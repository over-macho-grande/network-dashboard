{% extends "base.html" %}

{% block title %}Network Dashboard{% endblock %}

{% block content %}
<h1>Welcome, {{ username }} </h1>

<section class="grid">

  <!-- Wazuh alerts -->
  <div class="card">
    <h2>Wazuh Alerts</h2>
    {% if wazuh_alerts %}
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Level</th>
            <th>Agent</th>
            <th>Rule</th>
            <th>Time</th>
          </tr>
        </thead>
        <tbody>
        {% for a in wazuh_alerts %}
          <tr>
            <td>{{ a.id }}</td>
            <td class="severity severity-{{ a.level|lower }}">{{ a.level }}</td>
            <td>{{ a.agent }}</td>
            <td>{{ a.rule }}</td>
            <td>{{ a.time }}</td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p>No recent Wazuh alerts.</p>
    {% endif %}
  </div>

  <!-- LNMS alerts -->
  <div class="card">
    <div class="card-header" style="display:flex; justify-content:space-between; align-items:center;">
      <h2>LNMS Alerts</h2>

      <form method="get" action="{{ url_for('index') }}" class="lnms-time-filter">
        <label for="lnms_window">Time window:</label>
        <select name="lnms_window" id="lnms_window" onchange="this.form.submit()">
          <option value="1h"  {% if lnms_window == '1h'  %}selected{% endif %}>Last 1 hour</option>
          <option value="4h"  {% if lnms_window == '4h'  %}selected{% endif %}>Last 4 hours</option>
          <option value="24h" {% if lnms_window == '24h' %}selected{% endif %}>Last 24 hours</option>
          <option value="7d"  {% if lnms_window == '7d'  %}selected{% endif %}>Last 7 days</option>
        </select>
      </form>
    </div>

    {% if lnms_alerts %}
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Device</th>
            <th>Severity</th>
            <th>Message</th>
            <th>Time</th>
          </tr>
        </thead>
        <tbody>
        {% for a in lnms_alerts %}
          <tr>
            <td>{{ a.id }}</td>
            <td>{{ a.device }}</td>
            <td class="severity severity-{{ a.severity|lower }}">{{ a.severity }}</td>
            <td>{{ a.message }}</td>
            <td>{{ a.time }}</td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p>No recent LNMS alerts.</p>
    {% endif %}
  </div>

</section>

<!-- Top Devices Section -->
<section class="card">
  <h2>Top 10 Devices by Resource Usage</h2>
  <p class="text-muted" style="margin-top: -0.5rem; margin-bottom: 1rem; font-size: 0.85rem;">Click any device name to view detailed information</p>

  <div class="top-grid">

    <!-- CPU -->
    <div>
      <h3>CPU (%)</h3>
      {% if top_devices.cpu %}
        <ul class="device-list">
          {% for d in top_devices.cpu %}
            <li>
              {% if d.device_id %}
                <a href="{{ url_for('device_detail', device_id=d.device_id) }}" class="device-link">
                  {{ d.device }}
                </a>
              {% else %}
                {{ d.device }}
              {% endif %}
              <span class="device-value {{ 'value-high' if d.value >= 80 else ('value-medium' if d.value >= 60 else '') }}">{{ d.value }}%</span>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="text-muted">No CPU data available.</p>
      {% endif %}
    </div>

    <!-- RAM -->
    <div>
      <h3>RAM (%)</h3>
      {% if top_devices.ram %}
        <ul class="device-list">
          {% for d in top_devices.ram %}
            <li>
              {% if d.device_id %}
                <a href="{{ url_for('device_detail', device_id=d.device_id) }}" class="device-link">
                  {{ d.device }}
                </a>
              {% else %}
                {{ d.device }}
              {% endif %}
              <span class="device-value {{ 'value-high' if d.value >= 80 else ('value-medium' if d.value >= 60 else '') }}">{{ d.value }}%</span>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="text-muted">No RAM data available.</p>
      {% endif %}
    </div>

    <!-- Bandwidth -->
    <div>
      <h3>Bandwidth (Mbps)</h3>
      {% if top_devices.bandwidth %}
        <ul class="device-list">
          {% for d in top_devices.bandwidth %}
            <li>
              {% if d.device_id %}
                <a href="{{ url_for('device_detail', device_id=d.device_id) }}" class="device-link">
                  {{ d.device }}
                </a>
              {% else %}
                {{ d.device }}
              {% endif %}
              <span class="device-value">{{ '%.1f'|format(d.value) }} Mbps</span>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="text-muted">No bandwidth data available.</p>
      {% endif %}
    </div>

    <!-- Storage -->
    <div>
      <h3>Storage Used (%)</h3>
      {% if top_devices.storage %}
        <ul class="device-list">
          {% for d in top_devices.storage %}
            <li>
              {% if d.device_id %}
                <a href="{{ url_for('device_detail', device_id=d.device_id) }}" class="device-link">
                  {{ d.device }}
                </a>
              {% else %}
                {{ d.device }}
              {% endif %}
              <span class="device-value {{ 'value-high' if d.value >= 80 else ('value-medium' if d.value >= 60 else '') }}">{{ d.value }}%</span>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="text-muted">No storage data available.</p>
      {% endif %}
    </div>

  </div>
</section>

{% endblock %}
